<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>flow planner ¬∑ weekend + themes + notes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* ========== CSS variables (default dark, light) ========== */
        body {
            --bg-gradient-start: #1e2b30;
            --bg-gradient-end: #1f2f36;
            --card-bg: rgba(25, 38, 45, 0.7);
            --card-border: rgba(255, 255, 255, 0.06);
            --text-primary: #eef3f5;
            --text-secondary: #cbd5e0;
            --stat-bg: #3a4e58;
            --input-bg: #2c3f48;
            --input-placeholder: #99b2bf;
            --button-bg: #4f7b8c;
            --button-hover: #5f8fa2;
            --reset-bg: rgba(230, 120, 80, 0.9);
            --reset-hover: #e06e4f;
            --table-header-bg: #1f3a45;
            --table-cell-even: rgba(60, 86, 98, 0.3);
            --table-cell-odd: rgba(45, 69, 80, 0.2);
            --task-name-bg: #1d353f;
            --completion-row-bg: #1b3d45;
            --completion-text: #b1e6f0;
            --toast-bg: #2e5f4b;
            --shadow-dark: rgba(0, 0, 0, 0.5);
            --border-light: rgba(255,255,255,0.1);
            --chart-grid: #365f6b;
            --chart-label: #b6d0db;
            --chart-legend: #cbd5e0;
        }

        /* light theme */
        body.theme-light {
            --bg-gradient-start: #f0f4fa;
            --bg-gradient-end: #d9e2ec;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border: rgba(0, 0, 0, 0.08);
            --text-primary: #1e2b30;
            --text-secondary: #2c3f48;
            --stat-bg: #a6c0cf;
            --input-bg: #ffffff;
            --input-placeholder: #6f8a9c;
            --button-bg: #4f798b;
            --button-hover: #3f6375;
            --reset-bg: #d97c5c;
            --reset-hover: #bf6242;
            --table-header-bg: #cbdae3;
            --table-cell-even: rgba(160, 184, 197, 0.3);
            --table-cell-odd: rgba(200, 215, 225, 0.5);
            --task-name-bg: #d3e2ec;
            --completion-row-bg: #b8d0dd;
            --completion-text: #1d4c5c;
            --toast-bg: #3f886b;
            --shadow-dark: rgba(0, 0, 0, 0.2);
            --border-light: rgba(0,0,0,0.1);
            --chart-grid: #8ba3b3;
            --chart-label: #2c4b5c;
            --chart-legend: #2c4b5c;
        }

        body {
            background: linear-gradient(145deg, var(--bg-gradient-start), var(--bg-gradient-end));
            min-height: 100vh;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            transition: background 0.2s ease, color 0.2s;
        }

        .app-wrapper {
            max-width: 1400px;
            width: 100%;
        }

        /* top bar with stats + theme switcher */
        .top-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            gap: 1rem;
        }

        .title {
            font-size: 2.2rem;
            font-weight: 500;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 5px var(--shadow-dark);
        }

        .stats-card {
            background: var(--card-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--border-light);
            border-radius: 50px;
            padding: 0.6rem 1.6rem;
            display: flex;
            gap: 2rem;
            color: var(--text-primary);
            box-shadow: 0 8px 20px var(--shadow-dark);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .stat-value {
            font-weight: 600;
            font-size: 1.4rem;
            background: var(--stat-bg);
            padding: 0.2rem 0.8rem;
            border-radius: 40px;
            color: white;
        }

        /* theme switcher (only dark/light) */
        .theme-switcher {
            display: flex;
            gap: 0.4rem;
            background: var(--card-bg);
            backdrop-filter: blur(8px);
            padding: 0.5rem 0.8rem;
            border-radius: 60px;
            border: 1px solid var(--border-light);
        }

        .theme-btn {
            background: transparent;
            border: none;
            font-size: 1.4rem;
            padding: 0.3rem 0.6rem;
            border-radius: 40px;
            cursor: pointer;
            transition: 0.2s;
            filter: drop-shadow(0 2px 4px black);
            opacity: 0.7;
        }

        .theme-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: rgba(255,255,255,0.15);
        }

        .theme-btn.active {
            opacity: 1;
            background: rgba(255,255,255,0.25);
            box-shadow: 0 0 0 2px var(--text-secondary);
        }

        /* task creator */
        .task-creator {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin-bottom: 2.5rem;
            background: rgba(0,0,0,0.2);
            padding: 1.2rem 1.8rem;
            border-radius: 64px;
            backdrop-filter: blur(4px);
            border: 1px solid var(--border-light);
            box-shadow: 0 10px 25px -10px black;
        }

        .task-creator input {
            flex: 1 1 260px;
            background: var(--input-bg);
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            font-size: 1rem;
            color: var(--text-primary);
            outline: 2px solid transparent;
            transition: all 0.2s;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.4);
        }

        .task-creator input::placeholder {
            color: var(--input-placeholder);
            font-weight: 300;
        }

        .task-creator input:focus {
            outline: 2px solid var(--button-bg);
        }

        .task-creator button {
            background: var(--button-bg);
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 6px 14px var(--shadow-dark);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.3px;
            border: 1px solid var(--border-light);
        }

        .task-creator button:hover {
            background: var(--button-hover);
            transform: scale(1.02);
            box-shadow: 0 10px 20px var(--shadow-dark);
        }

        .reset-btn {
            background: var(--reset-bg) !important;
        }

        .reset-btn:hover {
            background: var(--reset-hover) !important;
        }

        /* table card (reused for weekend sections) */
        .table-container {
            background: var(--card-bg);
            backdrop-filter: blur(4px);
            border-radius: 32px;
            padding: 1.8rem 1.2rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 25px 45px -12px black;
            margin-bottom: 2.5rem;
            overflow-x: auto;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .schedule-table th {
            padding: 0.8rem 0.2rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--table-header-bg);
            border-radius: 12px 12px 0 0;
        }

        .schedule-table td {
            padding: 0.2rem;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-light);
        }

        .schedule-table th:nth-child(even),
        .schedule-table td:nth-child(even) {
            background-color: var(--table-cell-even);
        }

        .schedule-table th:nth-child(odd),
        .schedule-table td:nth-child(odd) {
            background-color: var(--table-cell-odd);
        }

        .task-name-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 0.3rem 0.5rem 0.3rem 0.8rem;
            background: var(--task-name-bg);
            border-radius: 40px;
            margin: 4px;
            box-shadow: inset 0 1px 3px #0e1f26;
            font-weight: 500;
            color: var(--text-primary);
        }

        .delete-task-btn {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: #ffa690;
            padding: 0 6px;
            border-radius: 30px;
            transition: 0.15s;
            line-height: 1;
        }

        .delete-task-btn:hover {
            color: #ff6f5c;
            transform: scale(1.15);
            background: rgba(0,0,0,0.2);
        }

        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--button-bg);
            border-radius: 6px;
            transition: 0.1s;
        }

        .completion-row td {
            background: var(--completion-row-bg) !important;
            color: var(--completion-text);
            font-weight: 600;
            font-size: 0.8rem;
            border-top: 2px solid var(--button-bg);
        }

        /* chart card */
        .chart-card {
            background: var(--card-bg);
            backdrop-filter: blur(4px);
            border-radius: 36px;
            padding: 1.5rem 1.2rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 20px 35px -10px black;
            margin-bottom: 2.5rem;
        }

        /* weekend section headings */
        .section-heading {
            font-size: 2rem;
            font-weight: 500;
            margin: 1.5rem 0 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* thoughts / notes section */
        .thoughts-container {
            background: var(--card-bg);
            backdrop-filter: blur(4px);
            border-radius: 32px;
            padding: 1.8rem 1.5rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 25px 45px -12px black;
            margin-bottom: 2rem;
        }

        .thoughts-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .thought-card {
            background: var(--task-name-bg);
            border-radius: 24px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            box-shadow: inset 0 1px 3px #0e1f26, 0 4px 10px var(--shadow-dark);
            border: 1px solid var(--border-light);
            min-width: 220px;
            max-width: 100%;
            color: var(--text-primary);
        }

        .thought-text {
            font-size: 1rem;
            word-break: break-word;
            flex: 1;
        }

        .delete-thought-btn {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: #ffa690;
            padding: 0 6px;
            border-radius: 30px;
            transition: 0.15s;
            line-height: 1;
        }

        .delete-thought-btn:hover {
            color: #ff6f5c;
            transform: scale(1.15);
            background: rgba(0,0,0,0.2);
        }

        .save-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--toast-bg);
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 60px;
            font-size: 0.95rem;
            font-weight: 500;
            box-shadow: 0 12px 25px var(--shadow-dark);
            opacity: 0;
            transition: opacity 0.25s ease;
            pointer-events: none;
            z-index: 999;
            border: 1px solid var(--border-light);
        }

        .save-toast.show {
            opacity: 1;
        }

        .empty-message {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-style: italic;
            background: var(--task-name-bg);
            border-radius: 60px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="theme-dark"> <!-- default -->
<div class="app-wrapper">
    <div class="top-bar">
        <h1 class="title">üìÖ flow planner</h1>
        <div class="stats-card">
            <div class="stat-item"><span>üìå tasks</span><span class="stat-value" id="total-tasks-count">0</span></div>
            <div class="stat-item"><span>‚ö° avg</span><span class="stat-value" id="avg-completion">0%</span></div>
        </div>
        <!-- theme switcher (only dark/light) -->
        <div class="theme-switcher">
            <button class="theme-btn" data-theme="theme-dark" title="dark">üåô</button>
            <button class="theme-btn" data-theme="theme-light" title="light">‚òÄÔ∏è</button>
        </div>
    </div>

    <!-- main (weekday) input row -->
    <div class="task-creator">
        <input type="text" id="new-task" placeholder="e.g., morning pages, study session ..." autocomplete="off">
        <button id="add-task">‚ûï Add task</button>
        <button id="reset-btn" class="reset-btn">‚ü≤ Reset all</button>
    </div>

    <!-- main table -->
    <div class="table-container">
        <table class="schedule-table" id="schedule-table">
            <thead><tr><th></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>18</th><th>19</th><th>20</th><th>21</th><th>22</th><th>23</th><th>24</th><th>25</th><th>26</th><th>27</th><th>28</th><th>29</th><th>30</th><th>31</th></tr></thead>
            <tbody id="task-rows"></tbody>
            <tfoot><tr id="completion-row" class="completion-row"><td><strong>üìä %</strong></td><td id="completion-1"></td><td id="completion-2"></td><td id="completion-3"></td><td id="completion-4"></td><td id="completion-5"></td><td id="completion-6"></td><td id="completion-7"></td><td id="completion-8"></td><td id="completion-9"></td><td id="completion-10"></td><td id="completion-11"></td><td id="completion-12"></td><td id="completion-13"></td><td id="completion-14"></td><td id="completion-15"></td><td id="completion-16"></td><td id="completion-17"></td><td id="completion-18"></td><td id="completion-19"></td><td id="completion-20"></td><td id="completion-21"></td><td id="completion-22"></td><td id="completion-23"></td><td id="completion-24"></td><td id="completion-25"></td><td id="completion-26"></td><td id="completion-27"></td><td id="completion-28"></td><td id="completion-29"></td><td id="completion-30"></td><td id="completion-31"></td></tr></tfoot>
        </table>
    </div>

    <!-- chart -->
    <div class="chart-card">
        <canvas id="completionChart" width="400" height="150"></canvas>
    </div>

    <!-- SATURDAY SECTION (identical structure) -->
    <div class="section-heading"><span>üóìÔ∏è Saturday</span></div>
    <div class="task-creator">
        <input type="text" id="saturday-task" placeholder="saturday tasks ..." autocomplete="off">
        <button id="add-saturday-task">‚ûï Add task</button>
    </div>
    <div class="table-container">
        <table class="schedule-table" id="saturday-table">
            <thead><tr><th></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>18</th><th>19</th><th>20</th><th>21</th><th>22</th><th>23</th><th>24</th><th>25</th><th>26</th><th>27</th><th>28</th><th>29</th><th>30</th><th>31</th></tr></thead>
            <tbody id="saturday-task-rows"></tbody>
            <tfoot><tr class="completion-row"><td><strong>üìä %</strong></td><td id="sat-completion-1"></td><td id="sat-completion-2"></td><td id="sat-completion-3"></td><td id="sat-completion-4"></td><td id="sat-completion-5"></td><td id="sat-completion-6"></td><td id="sat-completion-7"></td><td id="sat-completion-8"></td><td id="sat-completion-9"></td><td id="sat-completion-10"></td><td id="sat-completion-11"></td><td id="sat-completion-12"></td><td id="sat-completion-13"></td><td id="sat-completion-14"></td><td id="sat-completion-15"></td><td id="sat-completion-16"></td><td id="sat-completion-17"></td><td id="sat-completion-18"></td><td id="sat-completion-19"></td><td id="sat-completion-20"></td><td id="sat-completion-21"></td><td id="sat-completion-22"></td><td id="sat-completion-23"></td><td id="sat-completion-24"></td><td id="sat-completion-25"></td><td id="sat-completion-26"></td><td id="sat-completion-27"></td><td id="sat-completion-28"></td><td id="sat-completion-29"></td><td id="sat-completion-30"></td><td id="sat-completion-31"></td></tr></tfoot>
        </table>
    </div>

    <!-- SUNDAY SECTION -->
    <div class="section-heading"><span>‚òÄÔ∏è Sunday</span></div>
    <div class="task-creator">
        <input type="text" id="sunday-task" placeholder="sunday tasks ..." autocomplete="off">
        <button id="add-sunday-task">‚ûï Add task</button>
    </div>
    <div class="table-container">
        <table class="schedule-table" id="sunday-table">
            <thead><tr><th></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>18</th><th>19</th><th>20</th><th>21</th><th>22</th><th>23</th><th>24</th><th>25</th><th>26</th><th>27</th><th>28</th><th>29</th><th>30</th><th>31</th></tr></thead>
            <tbody id="sunday-task-rows"></tbody>
            <tfoot><tr class="completion-row"><td><strong>üìä %</strong></td><td id="sun-completion-1"></td><td id="sun-completion-2"></td><td id="sun-completion-3"></td><td id="sun-completion-4"></td><td id="sun-completion-5"></td><td id="sun-completion-6"></td><td id="sun-completion-7"></td><td id="sun-completion-8"></td><td id="sun-completion-9"></td><td id="sun-completion-10"></td><td id="sun-completion-11"></td><td id="sun-completion-12"></td><td id="sun-completion-13"></td><td id="sun-completion-14"></td><td id="sun-completion-15"></td><td id="sun-completion-16"></td><td id="sun-completion-17"></td><td id="sun-completion-18"></td><td id="sun-completion-19"></td><td id="sun-completion-20"></td><td id="sun-completion-21"></td><td id="sun-completion-22"></td><td id="sun-completion-23"></td><td id="sun-completion-24"></td><td id="sun-completion-25"></td><td id="sun-completion-26"></td><td id="sun-completion-27"></td><td id="sun-completion-28"></td><td id="sun-completion-29"></td><td id="sun-completion-30"></td><td id="sun-completion-31"></td></tr></tfoot>
        </table>
    </div>

    <!-- THOUGHTS & NOTES SECTION (new) -->
    <div class="section-heading"><span>üí≠ Thoughts & Notes</span></div>
    <div class="task-creator">
        <input type="text" id="thought-input" placeholder="write a quote, thought, or note ..." autocomplete="off">
        <button id="add-thought-btn">‚ûï Add thought</button>
    </div>
    <div class="thoughts-container">
        <div id="thoughts-list" class="thoughts-grid">
            <!-- thoughts will be injected here -->
        </div>
    </div>

    <!-- auto-save toast (shared) -->
    <div id="save-toast" class="save-toast">‚ú® auto-saved</div>
</div>

<script>
    (function() {
        // ---------- MAIN (weekday) data ----------
        let tasks = [];
        const taskRows = document.getElementById('task-rows');
        const newTaskInput = document.getElementById('new-task');
        const addBtn = document.getElementById('add-task');
        const resetBtn = document.getElementById('reset-btn');
        let chart;
        const dailyCompletion = Array(31).fill(0);
        const totalTasksSpan = document.getElementById('total-tasks-count');
        const avgCompletionSpan = document.getElementById('avg-completion');
        const toast = document.getElementById('save-toast');

        // ---------- SATURDAY data ----------
        let saturdayTasks = [];
        const saturdayRows = document.getElementById('saturday-task-rows');
        const satInput = document.getElementById('saturday-task');
        const addSatBtn = document.getElementById('add-saturday-task');
        const satCompletionCells = Array.from({length:31}, (_,i) => document.getElementById(`sat-completion-${i+1}`));

        // ---------- SUNDAY data ----------
        let sundayTasks = [];
        const sundayRows = document.getElementById('sunday-task-rows');
        const sunInput = document.getElementById('sunday-task');
        const addSunBtn = document.getElementById('add-sunday-task');
        const sunCompletionCells = Array.from({length:31}, (_,i) => document.getElementById(`sun-completion-${i+1}`));

        // ---------- THOUGHTS data ----------
        let thoughts = [];
        const thoughtsList = document.getElementById('thoughts-list');
        const thoughtInput = document.getElementById('thought-input');
        const addThoughtBtn = document.getElementById('add-thought-btn');

        // ---------- theme elements ----------
        const themeBtns = document.querySelectorAll('.theme-btn');
        const body = document.body;

        // shared auto-save toast
        function showAutoSave() {
            toast.classList.add('show');
            clearTimeout(window.toastTimer);
            window.toastTimer = setTimeout(() => toast.classList.remove('show'), 1000);
        }

        // ----- MAIN functions (existing) -----
        function saveMainTasks() {
            localStorage.setItem('planner_tasks', JSON.stringify(tasks));
            showAutoSave();
        }

        function loadMainTasks() {
            const stored = localStorage.getItem('planner_tasks');
            if (stored) { try { tasks = JSON.parse(stored); } catch (e) { tasks = []; } }
            else tasks = [];
            tasks = tasks.map(t => ({ ...t, completedDays: Array.isArray(t.completedDays) ? t.completedDays : [] }));
        }

        function renderMainTasks() {
            taskRows.innerHTML = '';
            if (tasks.length === 0) {
                taskRows.innerHTML = `<tr><td colspan="32" class="empty-message">‚ú® add a task ‚Äî your monthly tracker awaits ‚ú®</td></tr>`;
            } else {
                tasks.forEach(task => addMainTaskRow(task));
            }
            for (let d = 1; d <= 31; d++) updateMainCompletion(d);
            updateMainStats();
            updateChartFromDays();
        }

        function addMainTaskRow(task) {
            const { id, name, completedDays } = task;
            const tr = document.createElement('tr');
            tr.dataset.taskId = id;

            const tdName = document.createElement('td');
            const nameDiv = document.createElement('div');
            nameDiv.className = 'task-name-cell';
            nameDiv.innerHTML = `<span style="flex:1;">${escapeHTML(name)}</span>
                                <button class="delete-task-btn" data-task-id="${id}" title="delete task">üóëÔ∏è</button>`;
            tdName.appendChild(nameDiv);
            tr.appendChild(tdName);

            for (let day = 1; day <= 31; day++) {
                const td = document.createElement('td');
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.className = 'checkbox';
                chk.dataset.day = day;
                chk.dataset.taskId = id;
                if (completedDays.includes(day)) chk.checked = true;
                td.appendChild(chk);
                tr.appendChild(td);

                chk.addEventListener('change', function(e) {
                    const taskId = Number(this.dataset.taskId);
                    const dayNum = Number(this.dataset.day);
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return;
                    if (this.checked) {
                        if (!task.completedDays.includes(dayNum)) task.completedDays.push(dayNum);
                    } else {
                        const idx = task.completedDays.indexOf(dayNum);
                        if (idx !== -1) task.completedDays.splice(idx, 1);
                    }
                    updateMainCompletion(dayNum);
                    updateMainStats();
                    updateChartFromDays();
                    saveMainTasks();
                });
            }

            taskRows.appendChild(tr);

            const deleteBtn = nameDiv.querySelector('.delete-task-btn');
            deleteBtn.addEventListener('click', function() {
                const taskId = Number(this.dataset.taskId);
                tasks = tasks.filter(t => t.id !== taskId);
                renderMainTasks();
                saveMainTasks();
            });
        }

        function updateMainCompletion(day) {
            const checkboxes = document.querySelectorAll(`#task-rows input[data-day="${day}"]`);
            const total = checkboxes.length;
            if (total === 0) {
                document.getElementById(`completion-${day}`).textContent = '';
                dailyCompletion[day-1] = 0;
                return;
            }
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const percent = Math.round((checked / total) * 100);
            dailyCompletion[day-1] = percent;
            const cell = document.getElementById(`completion-${day}`);
            if (cell) cell.textContent = percent === 0 ? '' : percent + '%';
        }

        function updateMainStats() {
            totalTasksSpan.textContent = tasks.length;
            let sum = 0, count = 0;
            for (let d = 1; d <= 31; d++) {
                const val = dailyCompletion[d-1];
                if (val > 0) { sum += val; count++; }
            }
            const avg = count === 0 ? 0 : Math.round(sum / count);
            avgCompletionSpan.textContent = avg + '%';
        }

        function updateChartFromDays() {
            if (!chart) return;
            chart.data.datasets[0].data = [...dailyCompletion];
            chart.update();
        }

        // ----- SATURDAY functions (unchanged) -----
        function saveSaturdayTasks() {
            localStorage.setItem('saturday_tasks', JSON.stringify(saturdayTasks));
            showAutoSave();
        }

        function loadSaturdayTasks() {
            const stored = localStorage.getItem('saturday_tasks');
            if (stored) { try { saturdayTasks = JSON.parse(stored); } catch (e) { saturdayTasks = []; } }
            else saturdayTasks = [];
            saturdayTasks = saturdayTasks.map(t => ({ ...t, completedDays: Array.isArray(t.completedDays) ? t.completedDays : [] }));
        }

        function renderSaturdayTasks() {
            saturdayRows.innerHTML = '';
            if (saturdayTasks.length === 0) {
                saturdayRows.innerHTML = `<tr><td colspan="32" class="empty-message">‚ú® add saturday tasks ‚ú®</td></tr>`;
            } else {
                saturdayTasks.forEach(task => addSaturdayTaskRow(task));
            }
            for (let d = 1; d <= 31; d++) updateSaturdayCompletion(d);
        }

        function addSaturdayTaskRow(task) {
            const { id, name, completedDays } = task;
            const tr = document.createElement('tr');
            tr.dataset.taskId = id;

            const tdName = document.createElement('td');
            const nameDiv = document.createElement('div');
            nameDiv.className = 'task-name-cell';
            nameDiv.innerHTML = `<span style="flex:1;">${escapeHTML(name)}</span>
                                <button class="delete-task-btn" data-task-id="${id}" title="delete">üóëÔ∏è</button>`;
            tdName.appendChild(nameDiv);
            tr.appendChild(tdName);

            for (let day = 1; day <= 31; day++) {
                const td = document.createElement('td');
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.className = 'checkbox';
                chk.dataset.day = day;
                chk.dataset.taskId = id;
                if (completedDays.includes(day)) chk.checked = true;
                td.appendChild(chk);
                tr.appendChild(td);

                chk.addEventListener('change', function(e) {
                    const taskId = Number(this.dataset.taskId);
                    const dayNum = Number(this.dataset.day);
                    const task = saturdayTasks.find(t => t.id === taskId);
                    if (!task) return;
                    if (this.checked) {
                        if (!task.completedDays.includes(dayNum)) task.completedDays.push(dayNum);
                    } else {
                        const idx = task.completedDays.indexOf(dayNum);
                        if (idx !== -1) task.completedDays.splice(idx, 1);
                    }
                    updateSaturdayCompletion(dayNum);
                    saveSaturdayTasks();
                });
            }

            saturdayRows.appendChild(tr);

            const deleteBtn = nameDiv.querySelector('.delete-task-btn');
            deleteBtn.addEventListener('click', function() {
                const taskId = Number(this.dataset.taskId);
                saturdayTasks = saturdayTasks.filter(t => t.id !== taskId);
                renderSaturdayTasks();
                saveSaturdayTasks();
            });
        }

        function updateSaturdayCompletion(day) {
            const checkboxes = document.querySelectorAll(`#saturday-task-rows input[data-day="${day}"]`);
            const total = checkboxes.length;
            if (total === 0) {
                if (satCompletionCells[day-1]) satCompletionCells[day-1].textContent = '';
                return;
            }
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const percent = Math.round((checked / total) * 100);
            if (satCompletionCells[day-1]) satCompletionCells[day-1].textContent = percent === 0 ? '' : percent + '%';
        }

        // ----- SUNDAY functions (unchanged) -----
        function saveSundayTasks() {
            localStorage.setItem('sunday_tasks', JSON.stringify(sundayTasks));
            showAutoSave();
        }

        function loadSundayTasks() {
            const stored = localStorage.getItem('sunday_tasks');
            if (stored) { try { sundayTasks = JSON.parse(stored); } catch (e) { sundayTasks = []; } }
            else sundayTasks = [];
            sundayTasks = sundayTasks.map(t => ({ ...t, completedDays: Array.isArray(t.completedDays) ? t.completedDays : [] }));
        }

        function renderSundayTasks() {
            sundayRows.innerHTML = '';
            if (sundayTasks.length === 0) {
                sundayRows.innerHTML = `<tr><td colspan="32" class="empty-message">‚ú® add sunday tasks ‚ú®</td></tr>`;
            } else {
                sundayTasks.forEach(task => addSundayTaskRow(task));
            }
            for (let d = 1; d <= 31; d++) updateSundayCompletion(d);
        }

        function addSundayTaskRow(task) {
            const { id, name, completedDays } = task;
            const tr = document.createElement('tr');
            tr.dataset.taskId = id;

            const tdName = document.createElement('td');
            const nameDiv = document.createElement('div');
            nameDiv.className = 'task-name-cell';
            nameDiv.innerHTML = `<span style="flex:1;">${escapeHTML(name)}</span>
                                <button class="delete-task-btn" data-task-id="${id}" title="delete">üóëÔ∏è</button>`;
            tdName.appendChild(nameDiv);
            tr.appendChild(tdName);

            for (let day = 1; day <= 31; day++) {
                const td = document.createElement('td');
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.className = 'checkbox';
                chk.dataset.day = day;
                chk.dataset.taskId = id;
                if (completedDays.includes(day)) chk.checked = true;
                td.appendChild(chk);
                tr.appendChild(td);

                chk.addEventListener('change', function(e) {
                    const taskId = Number(this.dataset.taskId);
                    const dayNum = Number(this.dataset.day);
                    const task = sundayTasks.find(t => t.id === taskId);
                    if (!task) return;
                    if (this.checked) {
                        if (!task.completedDays.includes(dayNum)) task.completedDays.push(dayNum);
                    } else {
                        const idx = task.completedDays.indexOf(dayNum);
                        if (idx !== -1) task.completedDays.splice(idx, 1);
                    }
                    updateSundayCompletion(dayNum);
                    saveSundayTasks();
                });
            }

            sundayRows.appendChild(tr);

            const deleteBtn = nameDiv.querySelector('.delete-task-btn');
            deleteBtn.addEventListener('click', function() {
                const taskId = Number(this.dataset.taskId);
                sundayTasks = sundayTasks.filter(t => t.id !== taskId);
                renderSundayTasks();
                saveSundayTasks();
            });
        }

        function updateSundayCompletion(day) {
            const checkboxes = document.querySelectorAll(`#sunday-task-rows input[data-day="${day}"]`);
            const total = checkboxes.length;
            if (total === 0) {
                if (sunCompletionCells[day-1]) sunCompletionCells[day-1].textContent = '';
                return;
            }
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const percent = Math.round((checked / total) * 100);
            if (sunCompletionCells[day-1]) sunCompletionCells[day-1].textContent = percent === 0 ? '' : percent + '%';
        }

        // ----- THOUGHTS functions (new) -----
        function saveThoughts() {
            localStorage.setItem('planner_thoughts', JSON.stringify(thoughts));
            showAutoSave();
        }

        function loadThoughts() {
            const stored = localStorage.getItem('planner_thoughts');
            if (stored) { try { thoughts = JSON.parse(stored); } catch (e) { thoughts = []; } }
            else thoughts = [];
        }

        function renderThoughts() {
            thoughtsList.innerHTML = '';
            if (thoughts.length === 0) {
                thoughtsList.innerHTML = `<div class="empty-message" style="width:100%;">‚ú® add a thought, quote, or note ‚ú®</div>`;
            } else {
                thoughts.forEach(thought => addThoughtCard(thought));
            }
        }

        function addThoughtCard(thought) {
            const { id, text } = thought;
            const card = document.createElement('div');
            card.className = 'thought-card';
            card.dataset.thoughtId = id;
            card.innerHTML = `
                <span class="thought-text">${escapeHTML(text)}</span>
                <button class="delete-thought-btn" data-thought-id="${id}" title="delete note">üóëÔ∏è</button>
            `;
            thoughtsList.appendChild(card);

            const deleteBtn = card.querySelector('.delete-thought-btn');
            deleteBtn.addEventListener('click', function() {
                const tid = Number(this.dataset.thoughtId);
                thoughts = thoughts.filter(t => t.id !== tid);
                renderThoughts();
                saveThoughts();
            });
        }

        function addNewThought() {
            const text = thoughtInput.value.trim();
            if (!text) { alert('enter a thought'); return; }
            const newId = thoughts.length ? Math.max(...thoughts.map(t => t.id)) + 1 : 1;
            thoughts.push({ id: newId, text });
            renderThoughts();
            thoughtInput.value = '';
            saveThoughts();
        }

        // ----- chart init (unchanged) -----
        function initChart() {
            const ctx = document.getElementById('completionChart').getContext('2d');
            const style = getComputedStyle(body);
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 31 }, (_, i) => i + 1),
                    datasets: [{
                        label: 'daily completion %',
                        data: dailyCompletion,
                        borderColor: '#8fc9df',
                        backgroundColor: 'rgba(98, 165, 194, 0.2)',
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#c2e5f5',
                        pointBorderColor: '#2b5f77',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { labels: { color: style.getPropertyValue('--chart-legend').trim() || '#cbd5e0' } }
                    },
                    scales: {
                        x: { grid: { color: style.getPropertyValue('--chart-grid').trim() || '#365f6b' }, ticks: { color: style.getPropertyValue('--chart-label').trim() || '#b6d0db' } },
                        y: { min: 0, max: 100, grid: { color: style.getPropertyValue('--chart-grid').trim() || '#365f6b' }, ticks: { color: style.getPropertyValue('--chart-label').trim() || '#b6d0db', stepSize: 20 }
                        }
                    }
                }
            });
        }

        function updateChartTheme() {
            if (!chart) return;
            const style = getComputedStyle(body);
            chart.options.plugins.legend.labels.color = style.getPropertyValue('--chart-legend').trim();
            chart.options.scales.x.grid.color = style.getPropertyValue('--chart-grid').trim();
            chart.options.scales.x.ticks.color = style.getPropertyValue('--chart-label').trim();
            chart.options.scales.y.grid.color = style.getPropertyValue('--chart-grid').trim();
            chart.options.scales.y.ticks.color = style.getPropertyValue('--chart-label').trim();
            chart.update();
        }

        // ----- theme switcher (only dark/light) -----
        function setTheme(themeClass) {
            body.className = themeClass;
            localStorage.setItem('planner_theme', themeClass);
            themeBtns.forEach(btn => {
                if (btn.dataset.theme === themeClass) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            updateChartTheme();
        }

        const savedTheme = localStorage.getItem('planner_theme');
        if (savedTheme && (savedTheme === 'theme-dark' || savedTheme === 'theme-light')) {
            setTheme(savedTheme);
        } else {
            setTheme('theme-dark');
        }

        themeBtns.forEach(btn => {
            btn.addEventListener('click', () => setTheme(btn.dataset.theme));
        });

        // ----- event listeners for main -----
        function addNewTask() {
            const taskName = newTaskInput.value.trim();
            if (!taskName) { alert('enter a task'); return; }
            const newId = tasks.length ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
            tasks.push({ id: newId, name: taskName, completedDays: [] });
            renderMainTasks();
            newTaskInput.value = '';
            saveMainTasks();
        }

        function resetAll() {
            if (!confirm('Delete all main tasks?')) return;
            tasks = [];
            renderMainTasks();
            saveMainTasks();
        }

        addBtn.addEventListener('click', addNewTask);
        newTaskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewTask(); });
        resetBtn.addEventListener('click', resetAll);

        // ----- saturday events -----
        addSatBtn.addEventListener('click', function() {
            const name = satInput.value.trim();
            if (!name) return;
            const newId = saturdayTasks.length ? Math.max(...saturdayTasks.map(t => t.id)) + 1 : 1;
            saturdayTasks.push({ id: newId, name, completedDays: [] });
            renderSaturdayTasks();
            satInput.value = '';
            saveSaturdayTasks();
        });
        satInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addSatBtn.click(); });

        // ----- sunday events -----
        addSunBtn.addEventListener('click', function() {
            const name = sunInput.value.trim();
            if (!name) return;
            const newId = sundayTasks.length ? Math.max(...sundayTasks.map(t => t.id)) + 1 : 1;
            sundayTasks.push({ id: newId, name, completedDays: [] });
            renderSundayTasks();
            sunInput.value = '';
            saveSundayTasks();
        });
        sunInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addSunBtn.click(); });

        // ----- thoughts events -----
        addThoughtBtn.addEventListener('click', addNewThought);
        thoughtInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewThought(); });

        // ----- helper escapeHTML -----
        function escapeHTML(str) {
            return String(str).replace(/[&<>"]/g, function(m) {
                if (m === '&') return '&amp;'; if (m === '<') return '&lt;'; if (m === '>') return '&gt;'; if (m === '"') return '&quot;';
                return m;
            });
        }

        // ----- load all & render -----
        loadMainTasks();
        loadSaturdayTasks();
        loadSundayTasks();
        loadThoughts();
        initChart();
        renderMainTasks();
        renderSaturdayTasks();
        renderSundayTasks();
        renderThoughts();
        updateChartTheme(); // ensure chart matches theme after render
    })();
</script>
</body>
</html>
